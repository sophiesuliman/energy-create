<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Group Energy – Phone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <style>
    html,body{margin:0;background:#000;color:#fff;font:16px system-ui;height:100%}
    .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;height:100%}
    button{padding:14px 18px;border-radius:12px;border:0;background:#16a34a;color:#fff;font-weight:700}
    .meter{width:min(420px,90vw);height:18px;background:#222;border-radius:10px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#22d3ee,#a78bfa)}
    .note{opacity:.7;font-size:14px;text-align:center;max-width:90vw}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Join Energy</h2>
  <div class="meter"><div class="bar" id="bar"></div></div>
  <button id="start">Start (motion + optional mic)</button>
  <div class="note">Tip: move, bounce, clap. On some phones, mic requires HTTPS — motion works everywhere.</div>
</div>

<script>
const proto = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${proto}://${location.host}`);
ws.addEventListener("open", () => ws.send(JSON.stringify({type:"hello", role:"phone"})));

let started=false, vol=0, move=0;

function clamp01(x){return Math.max(0, Math.min(1, x));}

async function start() {
  if (started) return;
  started = true;
  document.getElementById('start').disabled = true;

  // motion
  if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
    try { await DeviceMotionEvent.requestPermission(); } catch {}
  }
  window.addEventListener("devicemotion", (e)=>{
    const ax = e.accelerationIncludingGravity?.x||0;
    const ay = e.accelerationIncludingGravity?.y||0;
    const az = e.accelerationIncludingGravity?.z||0;
    const mag = Math.sqrt(ax*ax+ay*ay+az*az);
    // normalize movement: 9.8 is gravity; subtract baseline then scale
    move = clamp01(Math.max(0, (mag-9.8)/6)); // rough normalization
  }, { passive:true });

  // optional mic (may require HTTPS on mobile)
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const src = ctx.createMediaStreamSource(stream);
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 512;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);

    function readAudio(){
      analyser.getByteTimeDomainData(data);
      // compute RMS
      let sum=0;
      for(let i=0;i<data.length;i++){
        const v = (data[i]-128)/128;
        sum += v*v;
      }
      const rms = Math.sqrt(sum/data.length);
      vol = clamp01(rms*3); // scale
      requestAnimationFrame(readAudio);
    }
    readAudio();
  } catch(err) {
    // mic unavailable; it's okay, motion still works
  }

  // send loop
  const bar = document.getElementById('bar');
  function tick(){
    // combine motion + audio; weight motion more for reliability
    const energy = clamp01(move*0.8 + vol*0.6);
    bar.style.width = `${Math.round(energy*100)}%`;
    try { ws.send(JSON.stringify({type:"energy", value: energy})); } catch {}
    setTimeout(tick, 50);
  }
  tick();
}

document.getElementById('start').addEventListener('click', start);
</script>
</body>
</html>
