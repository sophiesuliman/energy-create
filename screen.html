<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Group Energy â€“ Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>

  <!-- Reliable QR code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    html,body{margin:0;background:#000;overflow:hidden}
    canvas{display:block}
    #qrBox{position:fixed;right:16px;bottom:16px;padding:8px;background:#000;
           border:1px solid #333;border-radius:12px;z-index:10}
    #hint{position:fixed;left:16px;bottom:16px;color:#aaa;
          font:14px/1.3 system-ui;z-index:10}
    #link{position:fixed;right:16px;bottom:166px;color:#9ae6b4;
          font:14px/1.3 system-ui;z-index:10}
  </style>
</head>
<body>
  <canvas id="cnv"></canvas>
  <a id="link" target="_blank" rel="noreferrer"></a>
  <div id="qrBox"></div>
  <div id="hint">scan QR to join</div>

<script>
/* ----- websocket connection ----- */
const proto = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${proto}://${location.host}`);
ws.addEventListener("open", () => ws.send(JSON.stringify({type:"hello", role:"screen"})));

let energy = 0, target = 0;
ws.addEventListener("message", (e) => {
  const msg = JSON.parse(e.data||"{}");
  if (msg.type==="energy") target = Math.max(0, Math.min(1, msg.value));
});

/* ----- orb visual ----- */
function resize(){
  const c = document.getElementById('cnv');
  c.width = innerWidth; c.height = innerHeight;
}
addEventListener('resize', resize); resize();

function drawFrame(){
  const ctx=document.getElementById('cnv').getContext('2d');
  const w=ctx.canvas.width,h=ctx.canvas.height;

  energy += (target - energy) * 0.08;

  ctx.fillStyle="rgba(0,0,0,0.15)";
  ctx.fillRect(0,0,w,h);

  const t=performance.now()/1000,rBase=Math.min(w,h)*0.12;
  const r=rBase*(0.9+0.6*energy+0.07*Math.sin(t*4)),x=w/2,y=h/2;
  const g=ctx.createRadialGradient(x,y,r*0.3,x,y,r*1.2);
  const hue=(200+160*energy+(t*40)%360)%360;
  g.addColorStop(0,`hsla(${hue},100%,60%,0.95)`);
  g.addColorStop(1,`hsla(${(hue+120)%360},100%,10%,0.05)`);
  ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();

  requestAnimationFrame(drawFrame);
}
drawFrame();

/* ----- QR code + fallback link ----- */
const phoneURL = `${location.origin}/phone.html`;

const link = document.getElementById('link');
link.textContent = phoneURL.replace(/^https?:\/\//,'');
link.href = phoneURL;

new QRCode(document.getElementById("qrBox"), {
  text: phoneURL,
  width: 180,
  height: 180,
  colorDark: "#00ff66",   // bright green QR
  colorLight: "#000000",  // black background
  correctLevel: QRCode.CorrectLevel.M
});
</script>
</body>
</html>
