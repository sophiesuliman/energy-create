<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Orb Controller</title>
<style>
  :root { --bg:#0b0f17; --fg:#e8eefc; --muted:#93a0b4; }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0f17 0%,#121a29 100%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:24px;text-align:center}
  h1{margin:0 0 6px 0;font-weight:600}
  button{
    padding:14px 18px;border-radius:12px;border:1px solid #2a3852;background:#111a2a;color:var(--fg);cursor:pointer;
    font-size:16px;min-width:200px
  }
  .id{font-size:13px;color:var(--muted)}
  .ok{color:#86efac}.bad{color:#fca5a5}.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Phone Controller</h1>
  <div class="id">Display session: <code id="displayId">—</code></div>
  <button id="startBtn">Start motion</button>
  <div id="status" class="muted">Not connected</div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const targetId = qs.get('id') || '';
  document.getElementById('displayId').textContent = targetId || '(missing)';

  const btn = document.getElementById('startBtn');
  const statusEl = document.getElementById('status');

  let peer, conn, sending=false, lastSent=0;

  function setStatus(msg, ok=false){ statusEl.textContent = msg; statusEl.className = ok?'ok':'bad'; }

  async function requestMotionPermission(){
    // iOS requires explicit permission
    const DOE = window.DeviceOrientationEvent;
    if (DOE && typeof DOE.requestPermission === 'function') {
      const res = await DOE.requestPermission().catch(()=> 'denied');
      if (res !== 'granted') throw new Error('Motion permission denied');
    }
  }

  function startSending(){
    function handler(evt){
      const now = performance.now();
      if (now - lastSent < 33) return; // ~30Hz throttle
      lastSent = now;
      if(!conn || conn.open!==true) return;
      const {alpha, beta, gamma} = evt;
      conn.send({t:'ori', alpha, beta, gamma});
    }
    window.addEventListener('deviceorientation', handler, true);
  }

  btn.addEventListener('click', async () => {
    try{
      if(!targetId) { setStatus('No session id in URL', false); return; }
      btn.disabled = true;
      setStatus('Requesting motion permission…');
      await requestMotionPermission();

      setStatus('Connecting to display…');
      peer = new Peer(undefined, {debug:0}); // create with random id
      peer.on('open', () => {
        conn = peer.connect(targetId, {reliable:true});
        conn.on('open', () => {
          setStatus('Connected. Sending motion ✅', true);
          if(!sending){ startSending(); sending=true; }
        });
        conn.on('error', () => setStatus('Connection error', false));
        conn.on('close', () => setStatus('Disconnected', false));
      });
      peer.on('error', () => setStatus('Peer error', false));
    }catch(e){
      setStatus(e.message || 'Permission/connection error', false);
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
